# MAGI System Workflow
# A deliberation workflow modeled after Evangelion's MAGI system
# Three personas (scientist, nurturer, pragmatist) analyze from different perspectives and vote

name: magi
description: MAGI Deliberation System - Analyze from 3 perspectives and decide by majority

max_iterations: 5

steps:
  - name: melchior
    agent: ~/.takt/agents/magi/melchior.md
    allowed_tools:
      - Read
      - Glob
      - Grep
      - WebSearch
      - WebFetch
    status_rules_prompt: |
      # ⚠️ REQUIRED: Status Output Rules ⚠️

      **Without this tag, the workflow will stop.**
      Your final output MUST include a status tag following the rules below.

      ## Output Format

      | Judgment | Tag |
      |----------|-----|
      | In favor | `[MELCHIOR:APPROVE]` |
      | Against | `[MELCHIOR:REJECT]` |
      | Conditional approval | `[MELCHIOR:CONDITIONAL]` |

      ### Output Example

      ```
      [MELCHIOR:APPROVE]

      Reason: {Reason for approval}
      ```
    instruction_template: |
      # MAGI System Initiated

      ## Matter for Deliberation
      {task}

      ## Instructions
      You are MELCHIOR-1 of the MAGI System.
      Analyze the above from the perspective of a scientist/engineer and render your judgment.
    transitions:
      - condition: always
        next_step: balthasar

  - name: balthasar
    agent: ~/.takt/agents/magi/balthasar.md
    allowed_tools:
      - Read
      - Glob
      - Grep
      - WebSearch
      - WebFetch
    status_rules_prompt: |
      # ⚠️ REQUIRED: Status Output Rules ⚠️

      **Without this tag, the workflow will stop.**
      Your final output MUST include a status tag following the rules below.

      ## Output Format

      | Judgment | Tag |
      |----------|-----|
      | In favor | `[BALTHASAR:APPROVE]` |
      | Against | `[BALTHASAR:REJECT]` |
      | Conditional approval | `[BALTHASAR:CONDITIONAL]` |

      ### Output Example

      ```
      [BALTHASAR:APPROVE]

      Reason: {Reason for approval}
      ```
    instruction_template: |
      # MAGI System Continuing

      ## Matter for Deliberation
      {task}

      ## MELCHIOR-1's Judgment
      {previous_response}

      ## Instructions
      You are BALTHASAR-2 of the MAGI System.
      Analyze the above from the perspective of a nurturer and render your judgment.
      Consider MELCHIOR's judgment as reference, but make your own independent assessment.
    pass_previous_response: true
    transitions:
      - condition: always
        next_step: casper

  - name: casper
    agent: ~/.takt/agents/magi/casper.md
    allowed_tools:
      - Read
      - Glob
      - Grep
      - WebSearch
      - WebFetch
    status_rules_prompt: |
      # ⚠️ REQUIRED: Status Output Rules ⚠️

      **Without this tag, the workflow will stop.**
      Your final output MUST include a status tag following the rules below.

      ## Output Format

      Final conclusion by majority vote:

      | Judgment | Tag |
      |----------|-----|
      | Approved (2+ in favor) | `[MAGI:APPROVE]` |
      | Rejected (2+ against) | `[MAGI:REJECT]` |
      | Conditional approval | `[MAGI:CONDITIONAL]` |

      ### Output Example

      ```
      ## MAGI System Final Judgment

      | System | Judgment |
      |--------|----------|
      | MELCHIOR-1 | APPROVE |
      | BALTHASAR-2 | CONDITIONAL |
      | CASPER-3 | APPROVE |

      **Conclusion: [MAGI:APPROVE]**

      [Reasoning/Summary]
      ```
    instruction_template: |
      # MAGI System Final Deliberation

      ## Matter for Deliberation
      {task}

      ## Previous Judgments
      {previous_response}

      ## Instructions
      You are CASPER-3 of the MAGI System.
      Analyze the above from a practical/realistic perspective and render your judgment.

      **Finally, tally the judgments from all three and provide the final conclusion.**
    pass_previous_response: true
    transitions:
      - condition: always
        next_step: COMPLETE
