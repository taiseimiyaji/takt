# Default TAKT Piece
# Plan -> Architect -> Implement -> AI Review -> Reviewers (parallel: Architect + QA) -> Supervisor Approval
#
# Template Variables (auto-injected by buildInstruction):
#   {iteration}      - Piece-wide turn count (total movements executed across all agents)
#   {max_iterations} - Maximum iterations allowed for the piece
#   {movement_iteration} - Per-movement iteration count (how many times THIS movement has been executed)
#   {task}           - Original user request
#   {previous_response} - Output from the previous movement
#   {user_inputs}    - Accumulated user inputs during piece
#   {report_dir}     - Report directory name (e.g., "20250126-143052-task-summary")

name: default-hybrid-codex
description: Standard development piece with planning and specialized reviews

max_iterations: 30

stances:
  coding: ../stances/coding.md
  review: ../stances/review.md
  testing: ../stances/testing.md

personas:
  planner: ../personas/planner.md
  architect-planner: ../personas/architect-planner.md
  coder: ../personas/coder.md
  ai-antipattern-reviewer: ../personas/ai-antipattern-reviewer.md
  architecture-reviewer: ../personas/architecture-reviewer.md
  qa-reviewer: ../personas/qa-reviewer.md
  supervisor: ../personas/supervisor.md

instructions:
  plan: ../instructions/plan.md
  architect: ../instructions/architect.md
  implement: ../instructions/implement.md
  ai-review: ../instructions/ai-review.md
  ai-fix: ../instructions/ai-fix.md
  arbitrate: ../instructions/arbitrate.md
  review-arch: ../instructions/review-arch.md
  review-qa: ../instructions/review-qa.md
  fix: ../instructions/fix.md
  supervise: ../instructions/supervise.md

report_formats:
  plan: ../report-formats/plan.md
  architecture-design: ../report-formats/architecture-design.md
  ai-review: ../report-formats/ai-review.md
  architecture-review: ../report-formats/architecture-review.md
  qa-review: ../report-formats/qa-review.md
  validation: ../report-formats/validation.md
  summary: ../report-formats/summary.md

initial_movement: plan

loop_monitors:
  - cycle: [ai_review, ai_fix]
    threshold: 3
    judge:
      persona: supervisor
      instruction_template: |
        ai_review と ai_fix のループが {cycle_count} 回繰り返されました。

        各サイクルのレポートを確認し、このループが健全（進捗がある）か、
        非生産的（同じ問題を繰り返している）かを判断してください。

        **参照するレポート:**
        - AIレビュー結果: {report:04-ai-review.md}

        **判断基準:**
        - 各サイクルで新しい問題が発見・修正されているか
        - 同じ指摘が繰り返されていないか
        - 修正が実際に反映されているか
      rules:
        - condition: 健全（進捗あり）
          next: ai_review
        - condition: 非生産的（改善なし）
          next: reviewers

movements:
  - name: plan
    edit: false
    persona: planner
    report:
      name: 00-plan.md
      format: plan
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Bash
      - WebSearch
      - WebFetch
    rules:
      - condition: 要件が明確で実装可能
        next: architect
      - condition: ユーザーが質問をしている（実装タスクではない）
        next: COMPLETE
      - condition: 要件が不明確、情報不足
        next: ABORT
        appendix: |
          確認事項:
          - {質問1}
          - {質問2}
    instruction: plan

  - name: architect
    edit: false
    persona: architect-planner
    report:
      name: 01-architecture.md
      format: architecture-design
    allowed_tools:
      - Read
      - Glob
      - Grep
      - WebSearch
      - WebFetch
    rules:
      - condition: 小規模タスク（設計不要）
        next: implement
      - condition: 設計完了
        next: implement
      - condition: 情報不足、判断できない
        next: ABORT
    instruction: architect

  - name: implement
    edit: true
    persona: coder
    stance:
      - coding
      - testing
    provider: codex
    session: refresh
    report:
      - Scope: 02-coder-scope.md
      - Decisions: 03-coder-decisions.md
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Edit
      - Write
      - Bash
      - WebSearch
      - WebFetch
    permission_mode: edit
    rules:
      - condition: 実装完了
        next: ai_review
      - condition: 実装未着手（レポートのみ）
        next: ai_review
      - condition: 判断できない、情報不足
        next: ai_review
      - condition: ユーザー入力が必要
        next: implement
        requires_user_input: true
        interactive_only: true
    instruction: implement

  - name: ai_review
    edit: false
    persona: ai-antipattern-reviewer
    stance: review
    report:
      name: 04-ai-review.md
      format: ai-review
    allowed_tools:
      - Read
      - Glob
      - Grep
      - WebSearch
      - WebFetch
    rules:
      - condition: AI特有の問題なし
        next: reviewers
      - condition: AI特有の問題あり
        next: ai_fix
    instruction: ai-review

  - name: ai_fix
    edit: true
    persona: coder
    stance:
      - coding
      - testing
    provider: codex
    session: refresh
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Edit
      - Write
      - Bash
      - WebSearch
      - WebFetch
    permission_mode: edit
    rules:
      - condition: AI問題の修正完了
        next: ai_review
      - condition: 修正不要（指摘対象ファイル/仕様の確認済み）
        next: ai_no_fix
      - condition: 判断できない、情報不足
        next: ai_no_fix
    instruction: ai-fix

  - name: ai_no_fix
    edit: false
    persona: architecture-reviewer
    stance: review
    allowed_tools:
      - Read
      - Glob
      - Grep
    rules:
      - condition: ai_reviewの指摘が妥当（修正すべき）
        next: ai_fix
      - condition: ai_fixの判断が妥当（修正不要）
        next: reviewers
    instruction: arbitrate

  - name: reviewers
    parallel:
      - name: arch-review
        edit: false
        persona: architecture-reviewer
        stance: review
        report:
          name: 05-architect-review.md
          format: architecture-review
        allowed_tools:
          - Read
          - Glob
          - Grep
          - WebSearch
          - WebFetch
        rules:
          - condition: approved
          - condition: needs_fix
        instruction: review-arch

      - name: qa-review
        edit: false
        persona: qa-reviewer
        stance: review
        report:
          name: 06-qa-review.md
          format: qa-review
        allowed_tools:
          - Read
          - Glob
          - Grep
          - WebSearch
          - WebFetch
        rules:
          - condition: approved
          - condition: needs_fix
        instruction: review-qa
    rules:
      - condition: all("approved")
        next: supervise
      - condition: any("needs_fix")
        next: fix

  - name: fix
    edit: true
    persona: coder
    stance:
      - coding
      - testing
    provider: codex
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Edit
      - Write
      - Bash
      - WebSearch
      - WebFetch
    permission_mode: edit
    rules:
      - condition: 修正完了
        next: reviewers
      - condition: 判断できない、情報不足
        next: plan
    instruction: fix

  - name: supervise
    edit: false
    persona: supervisor
    stance: review
    report:
      - Validation: 07-supervisor-validation.md
      - Summary: summary.md
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Bash
      - WebSearch
      - WebFetch
    rules:
      - condition: すべて問題なし
        next: COMPLETE
      - condition: 要求未達成、テスト失敗、ビルドエラー
        next: plan
    instruction: supervise
